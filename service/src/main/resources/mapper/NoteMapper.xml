<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.devsss.aoeba.service.mapper.NoteMapper">

    <resultMap id="BaseResultMap" type="com.devsss.aoeba.service.domain.Note">
        <id property="id" column="id" jdbcType="VARCHAR"/>
        <result property="content" column="content" jdbcType="VARCHAR"/>
        <result property="createdAt" column="created_at" jdbcType="TIMESTAMP"/>
        <result property="deletedAt" column="deleted_at" jdbcType="TIMESTAMP"/>
        <result property="tags" column="tags" jdbcType="VARCHAR"/>
        <result property="title" column="title" jdbcType="VARCHAR"/>
        <result property="updatedAt" column="updated_at" jdbcType="TIMESTAMP"/>
        <result property="views" column="views" jdbcType="INTEGER"/>
        <result property="category" column="category" jdbcType="VARCHAR"/>
        <result property="img" column="img" jdbcType="VARCHAR"/>
        <result property="mark" column="mark" jdbcType="INTEGER"/>
    </resultMap>
    <insert id="insert">
        insert into note (id, content, created_at, tags, title, category, img)
        values (#{id}, #{content}, #{createdAt}, #{tags}, #{title}, #{category}, #{img})
    </insert>
    <update id="updateNoteInfoById">
        update note set
        <if test="note.content != null">content = #{note.content} ,</if>
        <if test="note.tags != null">tags = #{note.tags} ,</if>
        <if test="note.title != null">title= #{note.title} ,</if>
        <if test="note.views != null">views= #{note.views} ,</if>
        <if test="note.category != null">category = #{note.category} ,</if>
        <if test="note.mark != null">mark = #{note.mark} ,</if>
        <if test="note.img != null">img = #{note.img} ,</if>
        id = #{note.id}
        where id = #{note.id}
    </update>
    <update id="updateMarkById">
        update note
        set mark = #{mark}
        where id = #{id}
    </update>

    <select id="selectNoteById" resultMap="BaseResultMap">
        select *
        from note
        where id = #{id}
    </select>
    <select id="findByTagsAndKeyword" resultType="com.devsss.aoeba.service.domain.Note">
        select * from note where
        <if test="keyword != null and keyword != ''">
            <bind name="keywd" value="'%' + keyword + '%'"/>
            (title like #{keywd} or content like #{keywd} ) and
        </if>
        <if test="category != null  and category != ''">category = #{category} and</if>
        <if test="tags != null">
            id in (
            select b.note_id from note_tag_dz b WHERE b.tag_name in (
            <foreach collection="tags" separator="," item="item">
                #{item}
            </foreach>
            )) and
        </if>
        true
    </select>
    <select id="countCategory" resultType="java.util.Map">
        select category, count(1) size
        from note
        group by category
    </select>
    <select id="queryNotesByMark" resultType="com.devsss.aoeba.service.domain.Note">
        select *
        from note
        where mark = #{mark}
    </select>
    <select id="findTop10ByCreateAtDesc" resultType="com.devsss.aoeba.service.domain.Note">
        select *
        from note
        order by created_at desc
        limit 10
    </select>
</mapper>
